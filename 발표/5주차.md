### **6.2.7 multer**

**[멀티파트 데이터 형식]**

**form 태그의 enctype이 multipart/form-data인 경우**

- body-parser로는 처리할 수 없고 직접 파싱(해석)하기도 어려우므로 multer라는 미들웨어를 따로 사용하면 편리하다.
- multer 패키지 필요하다. (npm i multer)

**[multer 함수를 호출]**

- storage는 저장할 공간에 대한 정보
- diskStorage는 하드디스크에 업로드 파일을 저장한다는 것
- destination은 저장할 경로
- filename은 저장할 파일명 [파일명+현재시간.확장자]
- Limits는 업로드에 대한 제한 사항을 설정

**[multer의 미들웨어들]**

**single과 none, array, fields 미들웨어 존재**

- single은 하나의 파일을 업로드할 때, none은 파일은 업로드하지 않을 때
- req.file안에 업로드 정보 저장

<img src='./img/reqfile.JPG'/>
     → 이미지에 대한 정보가 여기에 보여준다. (배열로 보여준다)

- array와 fields는 여러 개의 파일을 업로드 할 때 사용한다.
- array는 하나의 요청 body 이름 아래 여러 파일이 있는 경우
- fields는 여러 개의 요청 body 이름 아래 파일이 하나씩 있는 경우
- 두 경우 모두 업로드된 이미지 정보가 req.files 아래에 존재한다.

## **6.3 Router 객체로 라우팅 분리하기**

라우터를 많이 연결하면 코드가 매우 길어지므로 익스프레스에서는 라우터를 분리할 수 있는 방법을 제공한다. 

**[라우터 매개변수]**

:id를 넣으면 req.params.id로 받을 수 있다.

- 동적으로 변하는 라우트 매개변수로 만든다.

<img src='./img/router1.JPG'/>

→ 주소에 :id가 있는데 문자 그대로 :id를 의미하는 것이 아니다. 이 부분에는 다른 값을 넣을 수 있다. 

- 주의할 점으로는 일반 라우터보다 뒤에 위치해야 한다.=


<img src='./img/router2.JPG'/>

→ 다양한 라우터를 아우르는 와일드카드 역할을 하므로 일반 라우터보다는 뒤에 위치해야 다른 라우터를 방해하지 않는다.

## **6.4 req, res 객체 살펴보기**

익스프레스의 req, res 객체는 http 모듈의 req, res 객체를 확장한 것이다. 

기존 http 모듈의 메서드도 사용할 수 있고, 익스프레스가 추가한 메서드나 속성을 사용할 수도 있다. 

**[req 객체]**

- **req.app** : req 객체를 통해 app 객체에 접근할 수 있다.
- **req.body** : body-parser 미들웨어가 만드는 요청의 본문을 해석한 객체이다.
- **req.cookies** : cookie-parser 미들웨어가 만드는 요청의 쿠키를 해석한 객체이다.
- **req.ip** : 요청의 ip 주소가 담겨 있다.
- **req.params** : 라우트 매개변수에 대한 정보가 담긴 객체이다.
- **req.query** : 쿼리스트링에 대한 정보가 담긴 객체이다.
- **req.signedCookies** : 서명된 쿠키들은 req.cookies 대신 여기에 담겨 있다.
- **req.get(헤더 이름)** : 헤더의 값을 가져오고 싶을 때 사용하는 메서드이다.

**[res 객체]**

- **res.app** :  req.app처럼 res 객체를 통해 app 객체에 접근할 수 있다.
- **res.cookies(키, 값, 옵션) :** 쿠키를 설정하는 메서드이다.
- **res.clearCookie(키, 값, 옵션)** : 쿠키를 제거하는 메서드이다.
- **res.end()** : 데이터 없이 응답을 보낸다.
- **res.json(JSON) :** JSON 형식의 응답을 보낸다.
- **res.redirect(주소) :** 리다이렉트할 주소와 함께 응답을 보낸다.
- **res.render(뷰, 데이터) :** 다음 절에서 다룰 템플릿 엔진을 렌더링해서 응답할 때 사용하는 메서드이다.
- **res.send(데이터)** : 데이터와 함께 응답을 보낸다. 데이터는 문자열일 수도 있고 HTML일수도 있으며, 버퍼일 수도 있고 객체나 배열일 수도 있다.
- **res.sendFile(경로) :** 경로에 위치한 파일을 응답한다.
- **res.set(헤더, 값) :** 응답의 헤더를 설정한다.
- **res.status(코드)** : 응답 시의 HTTP 상태 코드를 지정한다.

## **6.5 템플릿 엔진 사용하기**

HTML의 정적인 단점을 개선

- 반복문, 조건문, 변수 등을 사용할 수 있다.
- 동적인 페이지 작성 가능하다.
- PHP, JSP와 유사하다.

### 6.5.1 퍼그(제이드)

문법이 Ruby와 비슷해 코드 양이 많이 줄어들었다.

- HTML과 많이 달라 호불호가 갈린다.
- 익스프레스에 app.set으로 퍼그 연결한다.
- 퍼그 설치 : npm i pug

**6.5.1.1 Pug - HTML 표현**

- 기존 HTML과 다르게 화살괄호(< >)와 닫는 태그가 없다.
- 자식 태그는 부모 태그보다 들여쓰기 되어 있어야 한다.
    
    들여쓰기에 오류가 있으면 제대로 렌더링되지 않으니 주의!
    
- div 태그인 경우 div 문자는 생략할 수 있다.
- HTML 텍스트는 다음과 같이 태그 또는 속성 뒤에 한 칸을 띄고 입력하면 된다.
- 에디터에서 텍스트를 여러 줄 입력하고 싶다면 파이프( | )를 넣는다. → HTML코드에서는 한 줄로 나온다.
- style이나 script 태그로 CSS 또는 자바스크립트 코드를 작성하고 싶다면 태그 뒤에 점(.)을 붙인다.

**6.5.1.2 Pug - 변수**

서버로부터 받은 변수는 다양한 방식으로 퍼그에서 사용할 수 있다. 변수를 텍스트로 사용하고 싶다면 태그 뒤에 =을 붙인 후 변수를 입력한다. 속성에도 =을 붙인 후 변수를 사용할 수 있다. 텍스트 중간에 변수를 넣으려면 #{변수}를 사용하면 된다. 그러면 변수가 그 자리에 들어간다. #{}의 내부와 = 기호 뒷부분은 자바스크립트로 해석하므로 input 태그의 경우처럼 자바스크립트 구문을 써도 된다.

⇒ 서버에서 데이터를 클라이언트로 내려보낼 때 #{}와 =을 매우 빈번하게 사용하니 꼭 기억하자!

**6.5.1.3 Pug - 반복문**

HTML과 다르게 반복문도 사용할 수 있으며, 반복 가능한 변수인 경우에만 해당된다. 

⇒ for in이나 each in으로 반복문 돌릴 수 있다.

**6.5.1.4 Pug - 조건문** 

if, else, if else문, case when문이 사용 가능하다. 

**6.5.1.5 Pug - include**

퍼그 파일에 다른 퍼그 파일을 넣을 수 있다.

- 헤더, 푸터, 내비게이션 등의 공통 부분을 따로 관리할 수 있어 편리하다.
- include로 파일 경로 지정

**6.5.1.6 Pug - extends와 block**

레이아웃을 정할 수 있다.

- 공통되는 레이아웃을 따로 관리할 수 있어서 좋다.
- include와도 같이 사용

### 6.5.2 넌적스

Pug의 문법에 적응되지 않는다면 넌적스를 사용하면 좋다.

- Pug를 지우고 Nunjucks 설치 (npm i numjucks)
- 확장자는 html 또는 njk(view engine을 njk로)

**6.5.2.1 넌적스 - 변수**

- {{ 변수 }}
- 내부 변수 선언 가능 { %set 변수 = '값' % }
- HTML 이스케이프하고 싶지 않다면 {{ 변수 | safe }}를 사용한다.

**6.5.2.2 넌적스 - 반복문**

- {%  %} 안에 for in 작성한다. (인덱스는 loop 키워드)

**6.5.2.3 넌적스 - 조건문**

- {% if 변수 %} {% elif %} {% else %} {% endif %}로 이루어져 있다.

**6.5.2.4 넌적스 - include**

파일이 다른 파일을 불러올 수 있다. 

- include에 파일 경로 넣어줄 수 있다.
    
    ⇒ 퍼그와 동일하다.
    

**6.5.2.5 넌적스 - extends와 block**

레이아웃을 정할 수 있다. 

- 공통되는 레이아웃 부분을 따로 관리할 수 있어 좋다
- include와도 함께 사용하곤 한다.

### 6.5.3 에러 처리 미들웨어

에러 발생 시 템플릿 엔진과 상관없이 템플릿 엔진 변수를 설정하고 error 템플릿을 렌더링한다.
